---
title: "RPTEC_EG"
author: "Sem"
date: "2025-05-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
```

```{r}
data_dir <- "C:/Users/semde/Universiteit Leiden/BOO 2025 - BOO CDS Giulia team - BOO CDS Giulia team/Students/Sem/Data/RPTEC_TXG-MAPr"
expression_long   <- readRDS(file.path(data_dir, "expression_long.rds"))
module_definition        <- readRDS(file.path(data_dir, "module_definition.rds"))
eg_score          <- readRDS(file.path(data_dir, "eg_score.rds"))
module_annotation <- readRDS(file.path(data_dir, "module_annotation.rds"))
```



# Distribution of Log2FC and adjusted p-value

## Log2FC

```{r}
ggplot(expression_long, aes(x = log2fc)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "purple", alpha = 0.6) +
  geom_density(color = "darkblue") +
  theme_minimal() + labs(title = "Distribution of Log2FC in RPTEC dataset")
```

```{r}
sum(abs(expression_long$log2fc) > 1) # total log2fc > 1 ("biologically significant" fold change)
```


## p-adjusted

```{r}
ggplot(expression_long, aes(x = padj)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "skyblue", alpha = 0.6) +
  geom_density(color = "black") +
  theme_minimal() +
  labs(title = "Distribution of adjusted p-values in RPTEC dataset")
```

```{r}
sum(is.na(expression_long$padj)) # Na values in padj
```
Something did not went well with the padj values. Will adjust them myself with same method as pHH according to the TXG-MAPr paper (Benjamini Hochberg)

```{r}
expression_long$padj <- p.adjust(expression_long$pvalue, method = "BH")
```

```{r}
sum(is.na(expression_long$padj))
```

```{r}
sum(is.na(expression_long$padj) & is.na(expression_long$log2fc))
```

Still a lot of NA values, because there are nog fold change data for those genes.

```{r}
# Total number of NA genes per condition
expression_long %>%
  group_by(sample_id) %>%
  summarise(n_na = sum(is.na(pvalue))) %>%
  arrange(desc(n_na))
```

```{r}
# Total NA values for the modules with eg_score
sum(is.na(eg_score$eg_score))
```
ALl the modules still have eg_scores, even if there are missing values for padj and log2fc.

## Significant genes

```{r}
sum(expression_long$padj <  0.05, na.rm = TRUE)
```

## Both Log2FC and padj significant
Significant genes

```{r}
sum(abs(expression_long$log2fc) > 1 & expression_long$padj < 0.05, na.rm = TRUE)
```

# Gene Response Rate

The proposed Gene Response Rate reflects the total of significant genes (abs(Log2FC) > 1.0 & padj < 0.05) in a module with size n. This will be plotted against the eigengene score to assess this scoring method.

$$
GRR = \frac{ \displaystyle \sum_{i=1}^{n} \left( |\log_2 \mathrm{FC}_i| > 1.0 \ \land \ p_{\mathrm{adj},i} < 0.05 \right) }{ n }
$$

## Merge module_definition with expression_long

**A lot of NA values, can not use module size directly**. Therefore, the module size will be calculated as the number of entries after removal of NA values. 

```{r}
expression_long_filtered <- expression_long %>%
  filter(!is.na(padj), !is.na(log2fc)) # Remove NA values for padj and log2FC
```

```{r}
sum(is.na(expression_long_filtered$padj) & !is.na(expression_long_filtered$log2fc))
```
No NA values left

```{r}
# Add module information, using filtered data
expression_with_module <- expression_long_filtered %>%
  select(entrez_id, sample_id, log2fc, padj) %>%
  inner_join(
    module_definition %>% select(entrez_id, module_number),
    by = "entrez_id"
  ) %>%
  filter(module_number != 0)  # Remove irrelevant module 0
```

## Calculate significant genes and total per module

```{r}
# Calculate significant genes
expression_with_module <- expression_with_module %>%
  mutate(significant = abs(log2fc) > 1 & padj < 0.05)
```


```{r}
# Count significant genes per module
sig_count <- expression_with_module %>%
  group_by(module_number, sample_id) %>%
  summarise(sig_genes = sum(significant), .groups = "drop")
```

```{r}
# NA removal so the module_size variable is nog accurate anymore
module_size_per_sample <- expression_with_module %>% 
  group_by(module_number, sample_id) %>%
  summarise(module_size = n(), .groups = "drop")
```


## Add the module_size to sig_count and calculate GRR


```{r}
sig_count <- sig_count %>%
  left_join(module_size_per_sample, by = c("module_number", "sample_id")) %>%
  mutate(GRR = sig_genes / module_size)
```

## Join GRR with EG score per sample 

```{r}
GRR_vs_eg_score <- sig_count %>%
  inner_join(eg_score, by = c("module_number", "sample_id"))
```

## Density plots of GRR and EG score

```{r}
ggplot(GRR_vs_eg_score, aes(x = GRR)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "green", alpha = 0.6) +
  geom_density(color = "black") +
  theme_minimal() + labs(title = "Distribution of Gene Response Rate in RPTEC dataset")
```
Like expected, the GRR shows a logaritmic distribution due to the count data nature.

```{r}
ggplot(GRR_vs_eg_score, aes(x = eg_score)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "red", alpha = 0.6) +
  geom_density(color = "black") +
  theme_minimal() + labs(title = "Distribution of Eigengene Score in RPTEC dataset")
```
Eigengene shows a normal distribution, as expected due to the PCA use.

```{r}
ggplot(GRR_vs_eg_score, aes(x = abs_eg_score)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "red", alpha = 0.6) +
  geom_density(color = "black") +
  theme_minimal() + labs(title = "Distribution of Absolute Eigengene Score in RPTEC dataset")
```

## Visualize GRR vs EG score with a linear fit

```{r}
ggplot(GRR_vs_eg_score, aes(x = abs_eg_score, y = GRR)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  theme_minimal() +
  labs(
    title = "Gene Response Rate vs Eigengene Score in RPTEC",
    x = "Absolute Eigengene Score (EG)",
    y = "Gene Response Rate (GRR)"
  )
```

The linear fit does not follow the trend of the GRR vs EG, as expected due to the logarithmic distribution of the GRR. Next we will try to fit a different, logarthmic fit. To detect significant outliers.

## Binomial Generalized Linear Model (GLM)

```{r}
glm_fit <- glm(
  cbind(sig_genes, module_size - sig_genes) ~ abs_eg_score,
  family = binomial(link = "logit"),
  data = GRR_vs_eg_score
)
```

```{r}
# Make predictions and residuals
glm_predictions <- predict(glm_fit, type = "response")
glm_dev_resid <- residuals(glm_fit, type = "deviance")

# Combine into a new dataframe
GRR_glm_fit_df <- GRR_vs_eg_score %>%
  mutate(
    fitted_prob = glm_predictions,
    fitted_sig_genes = fitted_prob * module_size,
    residual = sig_genes - fitted_sig_genes,
    dev_resid = glm_dev_resid
  )
```

```{r}
ggplot(GRR_glm_fit_df, aes(x = abs_eg_score, y = GRR)) +
  geom_point(alpha = 0.5, size = 0.8) +
  geom_line(aes(y = fitted_sig_genes / module_size), color = "blue", size = 1) +
  theme_minimal() +
  labs(
    title = "Binomial GLM fit: GRR vs Eigengene Score in RPTEC",
    x = "Eigengene Score",
    y = "Gene Response Rate (GRR)"
  )
```

```{r}
summary(glm_fit)
```

```{r}
deviance(glm_fit) / df.residual(glm_fit)
```

```{r}
1 - (glm_fit$deviance / glm_fit$null.deviance)
```

### significant outliers 

For each module and sample, we compare the observed number of significant genes to the expected number based on the binomial GLM, and calculate a two-sided z-score and p-value using the binomial standard error. By doing this, the significant outlying modules from the glm fit are identified.

```{r}
GRR_glm_fit_df <- GRR_glm_fit_df %>%
  mutate(
    se_fit = sqrt(module_size * fitted_prob * (1 - fitted_prob)),
    z_score = (sig_genes - fitted_sig_genes) / se_fit,
    p_value = 2 * pnorm(-abs(z_score))  # two-sided test
  )
```

```{r}
GRR_glm_fit_df <- GRR_glm_fit_df %>%
  mutate(outlier = p_value < 0.05)
```

```{r}
sum(GRR_glm_fit_df$outlier, na.rm = TRUE)
```


```{r}
ggplot(GRR_glm_fit_df, aes(x = abs_eg_score, y = GRR)) +
  geom_point(aes(color = outlier), alpha = 0.6, size = 0.9) +
  geom_line(aes(y = fitted_sig_genes / module_size), color = "blue", size = 1) +
  scale_color_manual(values = c("black", "red")) +
  theme_minimal() +
  labs(
    title = "GRR vs Eigengene Score with Significant Outliers in RPTEC",
    x = "Eigengene Score",
    y = "Gene Response Rate (GRR)"
  )
```

## Modules and conditions with most significant outliers'

Based on the binomial GLM fit, we will now find the modules and conditions with the most significant outliers and with an abs eg_score > 2.0

```{r}
significant_outliers_filtered <- GRR_glm_fit_df %>%
  filter(outlier, abs(eg_score) > 2)
```

```{r}
outliers_per_module <- significant_outliers_filtered %>%
  count(module_number, sort = TRUE)
```

```{r}
outliers_per_sample <- significant_outliers_filtered %>%
  count(sample_id, sort = TRUE)
```

```{r}
head(outliers_per_module, 10) # Top modules with outliers
head(outliers_per_sample, 10) # Top cconditions with outliers
```

```{r}
outliers_per_module %>%
  top_n(30, n) %>%  # Top 30 modules
  ggplot(aes(x = reorder(as.factor(module_number), n), y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 30 modules with significant GRR outliers based on binomial GLM in RPTEC",
       x = "Module number",
       y = "Number of outliers")
```

```{r}
outliers_per_sample %>%
  top_n(30, n) %>%  # Top 30 conditions
  ggplot(aes(x = reorder(sample_id, n), y = n)) +
  geom_col(fill = "darkorange") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 30 conditions with significant GRR outliers in RPTEC",
       x = "Condition (sample_id)",
       y = "Number of outliers")
```
## Modules with most significant outliers based on binomial GLM and annotation (human)

```{r}
outliers_per_module <- outliers_per_module %>%
  mutate(module = paste0("hRPTECTERT1_", module_number))
```

```{r}
outliers_annotated <- outliers_per_module %>%
  inner_join(module_annotation, by = "module")
```

```{r}
outliers_annotated %>%
  arrange(desc(n)) %>%
  head(20)
```
Above shows the top modules with significant outliers from the GLM fit including annotation.

```{r}
outliers_annotated %>%
  arrange(desc(n)) %>%
  slice_head(n = 20) %>%
  ggplot(aes(x = reorder(module, n), y = n)) +
  geom_col(fill = "lightblue") +
  geom_text(aes(label = annotation), hjust = 1.1, color = "black", size = 3) +
  coord_flip() +
  theme_minimal() +
  labs(
    title = "Top 20 modules with significant GRR outliers in RPTEC",
    x = "Module",
    y = "Number of significant outliers"
  )
```
# Outliers per number of modules * number of samples

To compare this with PHH the number of outliers will be compared relative to the total modules and conditions.

```{r}
outlier_density <- GRR_glm_fit_df %>%
  filter(outlier, module_number != 0) %>%
  summarise(
    total_outliers = n(),
    total_modules = n_distinct(module_number),
    total_conditions = n_distinct(sample_id),
    density = total_outliers / (total_modules * total_conditions)
  )
```

```{r}
print(outlier_density)
```

